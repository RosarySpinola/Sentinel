# Prompt 2: User Authentication with Clerk

**Priority**: HIGHEST
**Skill**: ui-dev

---

## Pre-Task: Read Relevant Issues

Before starting, check for documented issues:
```bash
cat docs/issues/ui/README.md
cat docs/issues/movement/README.md
```

If issues exist related to authentication or wallet integration, read them first.

---

## Objective

Integrate Clerk authentication for user login/signup. Users can sign in with email or wallet. Sync user data to PostgreSQL database.

---

## Current State

- `frontend/` - Next.js app with wallet adapter only
- No user authentication system
- `frontend/package.json` - No Clerk dependency

---

## Requirements

### 1. Install Clerk Dependencies

```bash
cd frontend
npm install @clerk/nextjs
```

### 2. Configure Clerk Provider

Wrap the app with ClerkProvider in `app/layout.tsx`:
- Add ClerkProvider as outermost provider
- Keep existing WalletProvider inside ClerkProvider
- Keep ThemeProvider for dark mode

### 3. Create Auth Middleware

Create `frontend/middleware.ts`:
- Protect dashboard routes: `/simulator`, `/debugger`, `/gas`, `/prover`
- Allow public routes: `/`, `/sign-in`, `/sign-up`
- Redirect unauthenticated users to sign-in

### 4. Create Sign-In/Sign-Up Pages

Create auth pages using Clerk's components:

**`app/sign-in/[[...sign-in]]/page.tsx`**
- Use `<SignIn />` component
- Dark theme styling matching app
- Redirect to `/simulator` after sign-in

**`app/sign-up/[[...sign-up]]/page.tsx`**
- Use `<SignUp />` component
- Dark theme styling matching app
- Redirect to `/simulator` after sign-up

### 5. Create User Sync API Route

Create `app/api/auth/sync/route.ts`:
- Webhook endpoint for Clerk user events
- On user.created: Create user in PostgreSQL
- On user.updated: Update user in PostgreSQL
- On user.deleted: Soft delete user
- Verify webhook signature

### 6. Add User Menu to Dashboard

Modify `frontend/components/layouts/dashboard-header.tsx`:
- Replace placeholder avatar with `<UserButton />`
- Show user name/email
- Add sign-out option

### 7. Create Auth Hook

Create `frontend/lib/hooks/use-auth.ts`:
- Wrapper around `useUser()` from Clerk
- Add `getAccessToken()` for API calls
- Add `isAuthenticated` boolean

### 8. Update Environment Variables

Add to `frontend/.env.local.example`:
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
CLERK_SECRET_KEY=sk_test_xxx
CLERK_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/simulator
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/simulator
```

---

## Files to Create/Modify

- `frontend/package.json` - MODIFY - Add @clerk/nextjs
- `frontend/app/layout.tsx` - MODIFY - Add ClerkProvider
- `frontend/middleware.ts` - CREATE - Auth middleware
- `frontend/app/sign-in/[[...sign-in]]/page.tsx` - CREATE - Sign in page
- `frontend/app/sign-up/[[...sign-up]]/page.tsx` - CREATE - Sign up page
- `frontend/app/api/auth/sync/route.ts` - CREATE - User sync webhook
- `frontend/components/layouts/dashboard-header.tsx` - MODIFY - Add UserButton
- `frontend/lib/hooks/use-auth.ts` - CREATE - Auth hook
- `frontend/.env.local.example` - MODIFY - Add Clerk vars

---

## Context7 Documentation

Before implementing, fetch Clerk docs:
```
mcp__context7__resolve-library-id({ libraryName: "@clerk/nextjs" })
mcp__context7__get-library-docs({
  context7CompatibleLibraryID: "/clerk/clerk-nextjs",
  topic: "middleware",
  mode: "code"
})
```

---

## Verification

```bash
# 1. Check dependencies installed
cd frontend && npm list @clerk/nextjs

# 2. Check TypeScript compiles
npm run build

# 3. Start dev server
npm run dev

# 4. Test auth flow
# - Visit /simulator (should redirect to /sign-in)
# - Sign up with test email
# - Should redirect to /simulator after
# - User menu should show in header
```

---

## Success Criteria

- [ ] Clerk provider wraps entire app
- [ ] Middleware protects dashboard routes
- [ ] Sign-in and sign-up pages work
- [ ] User menu shows in dashboard header
- [ ] Webhook syncs users to database (when API running)
- [ ] All files under 300 lines

---

## Dependencies

- **Requires**: Prompt 1 (Database) for user sync
- **Blocks**: Prompt 3 (Projects), Prompt 5 (Teams)

---

## Notes

- Clerk free tier: 10,000 monthly active users
- Use Clerk's built-in dark mode support
- Consider adding wallet-based sign-in later (web3 auth)

---

## Document Issues

If you encounter problems, add to `docs/issues/ui/README.md`:
```markdown
## UI-001: [Issue Title]
**Problem**: What happened
**Root Cause**: Why it happened
**Solution**: How to fix it
**Prevention**: How to avoid in future
```
