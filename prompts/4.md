# Prompt 4: Historical Transaction Storage & Display

**Priority**: High
**Skill**: ui-dev

---

## Pre-Task: Read Relevant Issues

Before starting, check for documented issues:
```bash
cat docs/issues/ui/README.md
cat docs/issues/movement/README.md
```

---

## Objective

Store all simulation and prover runs in the database. Create a history page to browse past runs. Allow re-running simulations and viewing detailed results.

---

## Current State

- Database has `simulations` and `prover_runs` tables (from Prompt 1)
- Simulator and Prover pages work but don't save results
- No history viewing capability

---

## Requirements

### 1. Create History API Routes

Create API routes in `frontend/app/api/history/`:

**`simulations/route.ts`** (GET)
- Query params: `projectId`, `limit`, `offset`
- Returns paginated simulation history
- Includes: sender, module, function, success, gas, timestamp

**`simulations/[id]/route.ts`** (GET)
- Get full simulation details by ID
- Returns complete result JSON

**`prover-runs/route.ts`** (GET)
- Query params: `projectId`, `limit`, `offset`
- Returns paginated prover run history

**`prover-runs/[id]/route.ts`** (GET)
- Get full prover run details by ID

### 2. Create History Service

Create `frontend/lib/services/history-service.ts`:
- `listSimulations(projectId?, limit?, offset?)`
- `getSimulation(id)`
- `listProverRuns(projectId?, limit?, offset?)`
- `getProverRun(id)`

### 3. Create History Types

Create `frontend/lib/types/history.ts`:
```typescript
interface SimulationHistory {
  id: string;
  projectId?: string;
  sender: string;
  moduleAddress: string;
  moduleName: string;
  functionName: string;
  success: boolean;
  gasUsed: number;
  network: string;
  createdAt: Date;
}

interface ProverRunHistory {
  id: string;
  projectId?: string;
  moduleName: string;
  status: 'passed' | 'failed' | 'timeout' | 'error';
  durationMs: number;
  createdAt: Date;
}
```

### 4. Create History Page

Create `frontend/app/(dashboard)/history/page.tsx`:
- Tabs: "Simulations" | "Prover Runs"
- Filter by project (use project context)
- Paginated table with columns
- Click row to expand/view details
- "Re-run" button for simulations

### 5. Create History Components

Create in `frontend/app/(dashboard)/history/components/`:

**`simulation-table.tsx`**
- DataTable with columns: Time, Module, Function, Status, Gas
- Status badge (success=green, failed=red)
- Expandable row for details

**`prover-table.tsx`**
- DataTable with columns: Time, Module, Status, Duration
- Status badge based on result

**`history-filters.tsx`**
- Project selector
- Date range filter (optional)
- Search by module/function

**`simulation-detail-modal.tsx`**
- Full simulation result display
- State changes, events, gas breakdown
- "Re-run" and "Copy" buttons

### 6. Create History Hook

Create `frontend/app/(dashboard)/history/hooks/use-history.ts`:
- Fetch history with pagination
- Filter by project
- Handle loading/error states

### 7. Update Simulator to Save Results

Modify `frontend/app/(dashboard)/simulator/hooks/use-simulation.ts`:
- After successful simulation, POST to save endpoint
- Include project ID if one is selected
- Don't block UI on save (fire and forget)

### 8. Update Prover to Save Results

Modify `frontend/app/(dashboard)/prover/hooks/use-prover.ts`:
- After prover run completes, POST to save endpoint
- Include project ID if selected
- Save full result JSON

### 9. Create Save Endpoints

Create API routes:

**`frontend/app/api/history/simulations/route.ts`** (POST)
- Save simulation result to database
- Return saved simulation ID

**`frontend/app/api/history/prover-runs/route.ts`** (POST)
- Save prover run to database
- Return saved run ID

### 10. Add History to Sidebar

Modify `frontend/components/layouts/dashboard-sidebar.tsx`:
- Add "History" link with clock icon
- Below existing navigation items

---

## Files to Create/Modify

- `frontend/app/api/history/simulations/route.ts` - CREATE
- `frontend/app/api/history/simulations/[id]/route.ts` - CREATE
- `frontend/app/api/history/prover-runs/route.ts` - CREATE
- `frontend/app/api/history/prover-runs/[id]/route.ts` - CREATE
- `frontend/lib/services/history-service.ts` - CREATE
- `frontend/lib/types/history.ts` - CREATE
- `frontend/app/(dashboard)/history/page.tsx` - CREATE
- `frontend/app/(dashboard)/history/components/simulation-table.tsx` - CREATE
- `frontend/app/(dashboard)/history/components/prover-table.tsx` - CREATE
- `frontend/app/(dashboard)/history/components/history-filters.tsx` - CREATE
- `frontend/app/(dashboard)/history/components/simulation-detail-modal.tsx` - CREATE
- `frontend/app/(dashboard)/history/hooks/use-history.ts` - CREATE
- `frontend/app/(dashboard)/simulator/hooks/use-simulation.ts` - MODIFY
- `frontend/app/(dashboard)/prover/hooks/use-prover.ts` - MODIFY
- `frontend/components/layouts/dashboard-sidebar.tsx` - MODIFY

---

## Verification

```bash
# 1. TypeScript compiles
cd frontend && npm run build

# 2. Start dev server
npm run dev

# 3. Manual testing
# - Run a simulation
# - Go to /history
# - See simulation in list
# - Click to view details
# - Run prover
# - See prover run in history
# - Filter by project
```

---

## Success Criteria

- [ ] History page displays simulations tab
- [ ] History page displays prover runs tab
- [ ] Simulations auto-save after running
- [ ] Prover runs auto-save after running
- [ ] Can view full details of any history item
- [ ] Can re-run simulation from history
- [ ] Project filter works
- [ ] Pagination works
- [ ] All files under 300 lines

---

## Dependencies

- **Requires**: Prompt 1 (Database), Prompt 2 (Auth), Prompt 3 (Projects)
- **Blocks**: None

---

## UI Guidelines

- Use shadcn/ui DataTable pattern
- Show relative time ("5 minutes ago", "Yesterday")
- Truncate long addresses with ellipsis
- Add loading skeletons for table rows
