# Prompt 5: Team Workspaces

**Priority**: Medium
**Skill**: ui-dev

---

## Pre-Task: Read Relevant Issues

Before starting, check for documented issues:
```bash
cat docs/issues/ui/README.md
```

---

## Objective

Create team workspaces that allow multiple users to collaborate on projects. Teams have members with different roles (owner, admin, member). Projects can be shared with a team.

---

## Current State

- Users and projects exist (Prompts 1-3)
- Projects are personal (single owner)
- No team concept in database

---

## Requirements

### 1. Add Database Migration

Create `api/migrations/002_teams.sql`:

**teams**
- `id` UUID PRIMARY KEY
- `name` VARCHAR(255) NOT NULL
- `slug` VARCHAR(255) UNIQUE NOT NULL (URL-friendly name)
- `created_by` UUID REFERENCES users(id)
- `created_at` TIMESTAMP DEFAULT NOW()
- `updated_at` TIMESTAMP DEFAULT NOW()

**team_members**
- `id` UUID PRIMARY KEY
- `team_id` UUID REFERENCES teams(id) ON DELETE CASCADE
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `role` VARCHAR(50) NOT NULL (owner, admin, member)
- `invited_at` TIMESTAMP DEFAULT NOW()
- `joined_at` TIMESTAMP
- UNIQUE(team_id, user_id)

**team_invites**
- `id` UUID PRIMARY KEY
- `team_id` UUID REFERENCES teams(id) ON DELETE CASCADE
- `email` VARCHAR(255) NOT NULL
- `role` VARCHAR(50) NOT NULL DEFAULT 'member'
- `token` VARCHAR(255) UNIQUE NOT NULL
- `expires_at` TIMESTAMP NOT NULL
- `created_at` TIMESTAMP DEFAULT NOW()

**Modify projects table:**
- ADD `team_id` UUID REFERENCES teams(id) ON DELETE SET NULL
- Projects with team_id are shared with entire team

### 2. Create Team API Routes

Create in `frontend/app/api/teams/`:

**`route.ts`** (GET, POST)
- GET: List user's teams (as member or owner)
- POST: Create new team

**`[id]/route.ts`** (GET, PUT, DELETE)
- GET: Get team details with members
- PUT: Update team (name, slug) - admin/owner only
- DELETE: Delete team - owner only

**`[id]/members/route.ts`** (GET, POST)
- GET: List team members
- POST: Invite member by email

**`[id]/members/[userId]/route.ts`** (PUT, DELETE)
- PUT: Change member role - admin/owner only
- DELETE: Remove member - admin/owner only

**`invites/[token]/route.ts`** (GET, POST)
- GET: Get invite details
- POST: Accept invite

### 3. Create Team Service

Create `frontend/lib/services/teams-service.ts`:
- `listTeams()` - Get user's teams
- `getTeam(id)` - Get team with members
- `createTeam(name)` - Create team
- `updateTeam(id, data)` - Update team
- `deleteTeam(id)` - Delete team
- `inviteMember(teamId, email, role)` - Send invite
- `removeMember(teamId, userId)` - Remove member
- `updateMemberRole(teamId, userId, role)` - Change role
- `acceptInvite(token)` - Accept invitation

### 4. Create Team Types

Create `frontend/lib/types/team.ts`:
```typescript
type TeamRole = 'owner' | 'admin' | 'member';

interface Team {
  id: string;
  name: string;
  slug: string;
  createdAt: Date;
  memberCount: number;
  projectCount: number;
}

interface TeamMember {
  id: string;
  userId: string;
  email: string;
  name?: string;
  role: TeamRole;
  joinedAt?: Date;
}

interface TeamInvite {
  id: string;
  email: string;
  role: TeamRole;
  expiresAt: Date;
}
```

### 5. Create Teams Page

Create `frontend/app/(dashboard)/teams/page.tsx`:
- List all teams user belongs to
- Show role in each team
- "Create Team" button
- Click team to manage

### 6. Create Team Detail Page

Create `frontend/app/(dashboard)/teams/[id]/page.tsx`:
- Team name and settings
- Members list with roles
- Invite member form
- Projects shared with team
- Leave team button (if not owner)
- Delete team button (if owner)

### 7. Create Team Components

Create in `frontend/app/(dashboard)/teams/components/`:

**`team-card.tsx`**
- Team info card for list view
- Shows member count, project count
- Role badge

**`create-team-dialog.tsx`**
- Form to create new team
- Name input, auto-generate slug

**`invite-member-dialog.tsx`**
- Email input
- Role selector
- Send invite button

**`member-list.tsx`**
- Table of team members
- Role badges and actions
- Remove/change role buttons

**`pending-invites.tsx`**
- List of pending invitations
- Revoke invite option

### 8. Create Team Context

Create `frontend/lib/contexts/team-context.tsx`:
- `TeamProvider` component
- `useTeam()` hook
- Store selected team in localStorage
- Switch between personal and team context

### 9. Update Project Creation

Modify `frontend/app/(dashboard)/projects/components/create-project-dialog.tsx`:
- Add optional team selector
- If team selected, project is shared

### 10. Add Team Switcher to Header

Modify `frontend/components/layouts/dashboard-header.tsx`:
- Add team/personal switcher
- Shows "Personal" or team name
- Dropdown to switch contexts

---

## Files to Create/Modify

- `api/migrations/002_teams.sql` - CREATE
- `api/src/db/teams.rs` - CREATE
- `api/src/db/team_members.rs` - CREATE
- `frontend/app/api/teams/route.ts` - CREATE
- `frontend/app/api/teams/[id]/route.ts` - CREATE
- `frontend/app/api/teams/[id]/members/route.ts` - CREATE
- `frontend/app/api/teams/[id]/members/[userId]/route.ts` - CREATE
- `frontend/app/api/teams/invites/[token]/route.ts` - CREATE
- `frontend/lib/services/teams-service.ts` - CREATE
- `frontend/lib/types/team.ts` - CREATE
- `frontend/app/(dashboard)/teams/page.tsx` - CREATE
- `frontend/app/(dashboard)/teams/[id]/page.tsx` - CREATE
- `frontend/app/(dashboard)/teams/components/team-card.tsx` - CREATE
- `frontend/app/(dashboard)/teams/components/create-team-dialog.tsx` - CREATE
- `frontend/app/(dashboard)/teams/components/invite-member-dialog.tsx` - CREATE
- `frontend/app/(dashboard)/teams/components/member-list.tsx` - CREATE
- `frontend/app/(dashboard)/teams/components/pending-invites.tsx` - CREATE
- `frontend/lib/contexts/team-context.tsx` - CREATE
- `frontend/app/(dashboard)/projects/components/create-project-dialog.tsx` - MODIFY
- `frontend/components/layouts/dashboard-header.tsx` - MODIFY
- `frontend/components/layouts/dashboard-sidebar.tsx` - MODIFY

---

## Verification

```bash
# 1. Run migration
cd api && sqlx migrate run

# 2. TypeScript compiles
cd frontend && npm run build

# 3. Manual testing
# - Create a team
# - Invite member by email
# - Accept invite (in different browser/incognito)
# - Create project and assign to team
# - Both members can see project
# - Test role permissions
```

---

## Success Criteria

- [ ] Can create a team
- [ ] Can invite members by email
- [ ] Invites can be accepted via link
- [ ] Member roles work (owner > admin > member)
- [ ] Team projects visible to all members
- [ ] Can switch between personal and team context
- [ ] Proper permission checks on all actions
- [ ] All files under 300 lines

---

## Dependencies

- **Requires**: Prompt 1 (Database), Prompt 2 (Auth), Prompt 3 (Projects)
- **Blocks**: None

---

## Permission Matrix

| Action | Owner | Admin | Member |
|--------|-------|-------|--------|
| View team | ✅ | ✅ | ✅ |
| Edit team name | ✅ | ✅ | ❌ |
| Invite members | ✅ | ✅ | ❌ |
| Remove members | ✅ | ✅* | ❌ |
| Change roles | ✅ | ❌ | ❌ |
| Delete team | ✅ | ❌ | ❌ |
| Create project | ✅ | ✅ | ✅ |

*Admins can only remove members, not other admins
