# Prompt 6: API Key Management

**Priority**: High
**Skill**: api-dev

---

## Pre-Task: Read Relevant Issues

Before starting, check for documented issues:
```bash
cat docs/issues/tooling/README.md
```

---

## Objective

Create API key management for programmatic access. Users can generate API keys for use with the GitHub Action and direct API calls. Keys have expiration dates and usage tracking.

---

## Current State

- Database has `api_keys` table (from Prompt 1)
- Rust API has no authentication middleware
- GitHub Action exists but doesn't verify API keys

---

## Requirements

### 1. Add Crypto Dependencies to Rust API

Add to `api/Cargo.toml`:
- `argon2` for password hashing (API key storage)
- `rand` for random key generation
- `base64` for encoding

### 2. Create API Key Utilities

Create `api/src/auth/mod.rs`:
```rust
mod api_key;
mod middleware;
pub use api_key::*;
pub use middleware::*;
```

Create `api/src/auth/api_key.rs`:
- `generate_api_key()` -> Returns (raw_key, key_hash, key_prefix)
- `verify_api_key(raw_key, hash)` -> bool
- `hash_api_key(raw_key)` -> String
- Key format: `stl_live_xxxxxxxxxxxxxxxxxxxx` (32 chars)

### 3. Create Auth Middleware

Create `api/src/auth/middleware.rs`:
- Extract API key from `Authorization: Bearer <key>` header
- Or from `X-API-Key: <key>` header
- Look up key hash in database
- Reject if not found or expired
- Update `last_used_at` on successful auth
- Add user_id to request extensions

### 4. Create API Key Endpoints

Create `api/src/routes/api_keys.rs`:

**POST /api/v1/api-keys**
- Requires session auth (Clerk JWT)
- Body: { name, expires_in_days? }
- Generates new API key
- Stores hash in database
- Returns raw key ONCE (never stored)

**GET /api/v1/api-keys**
- Requires session auth
- Lists user's API keys
- Returns: id, name, key_prefix, last_used_at, expires_at, created_at
- Does NOT return the key itself

**DELETE /api/v1/api-keys/:id**
- Requires session auth
- Revokes (deletes) an API key

### 5. Apply Auth Middleware to Protected Routes

Modify protected routes to require API key:
- POST /api/v1/simulate
- POST /api/v1/simulate/batch
- POST /api/v1/trace
- POST /api/v1/analyze-gas
- POST /api/v1/prove

Keep health check public:
- GET /health

### 6. Create Frontend API Keys Page

Create `frontend/app/(dashboard)/settings/api-keys/page.tsx`:
- List existing API keys
- Show: name, prefix (stl_live_xxxx...), created, last used, expires
- "Create API Key" button
- Delete key with confirmation

### 7. Create API Key Components

Create in `frontend/app/(dashboard)/settings/api-keys/components/`:

**`api-key-list.tsx`**
- Table of API keys
- Columns: Name, Key (prefix only), Created, Last Used, Expires, Actions
- Delete button per row

**`create-api-key-dialog.tsx`**
- Name input (required)
- Expiration select (30 days, 90 days, 1 year, never)
- Shows generated key ONCE after creation
- Copy button
- Warning: "This is the only time you'll see this key"

### 8. Create API Key Service

Create `frontend/lib/services/api-keys-service.ts`:
- `listApiKeys()` - Get user's keys
- `createApiKey(name, expiresInDays?)` - Create new key
- `deleteApiKey(id)` - Revoke key

### 9. Create API Key Hook

Create `frontend/app/(dashboard)/settings/api-keys/hooks/use-api-keys.ts`:
- Manage API keys state
- Create/delete with confirmation
- Copy to clipboard helper

### 10. Add Settings to Sidebar

Modify `frontend/components/layouts/dashboard-sidebar.tsx`:
- Add "Settings" section at bottom
- Link to API Keys page

### 11. Update GitHub Action Documentation

Modify `action/README.md`:
- Add section on getting API key
- Show how to store in GitHub Secrets
- Example workflow using the key

---

## Files to Create/Modify

- `api/Cargo.toml` - MODIFY - Add argon2, rand, base64
- `api/src/auth/mod.rs` - CREATE
- `api/src/auth/api_key.rs` - CREATE
- `api/src/auth/middleware.rs` - CREATE
- `api/src/routes/api_keys.rs` - CREATE
- `api/src/routes/mod.rs` - MODIFY - Add api_keys
- `api/src/routes/simulate.rs` - MODIFY - Add auth
- `api/src/routes/batch.rs` - MODIFY - Add auth
- `api/src/routes/trace.rs` - MODIFY - Add auth
- `api/src/routes/gas.rs` - MODIFY - Add auth
- `api/src/routes/prover.rs` - MODIFY - Add auth
- `api/src/main.rs` - MODIFY - Add auth layer
- `frontend/app/(dashboard)/settings/api-keys/page.tsx` - CREATE
- `frontend/app/(dashboard)/settings/api-keys/components/api-key-list.tsx` - CREATE
- `frontend/app/(dashboard)/settings/api-keys/components/create-api-key-dialog.tsx` - CREATE
- `frontend/app/(dashboard)/settings/api-keys/hooks/use-api-keys.ts` - CREATE
- `frontend/lib/services/api-keys-service.ts` - CREATE
- `frontend/components/layouts/dashboard-sidebar.tsx` - MODIFY
- `action/README.md` - MODIFY

---

## API Key Format

```
stl_live_xxxxxxxxxxxxxxxxxxxxxxxx
└─┬─┘└┬─┘└──────────┬───────────┘
  │   │              │
  │   │              └─ 24 random chars (base64url)
  │   └─ environment (live/test)
  └─ prefix (sentinel)
```

Total: 32 characters

---

## Verification

```bash
# 1. Cargo compiles
cd api && cargo check

# 2. Test key generation
cargo test auth::api_key

# 3. Test protected endpoint without key
curl -X POST http://localhost:3001/api/v1/simulate \
  -H "Content-Type: application/json" \
  -d '{"network":"testnet",...}'
# Should return 401 Unauthorized

# 4. Test with valid key
curl -X POST http://localhost:3001/api/v1/simulate \
  -H "Authorization: Bearer stl_live_xxxx" \
  -H "Content-Type: application/json" \
  -d '{"network":"testnet",...}'
# Should return simulation result

# 5. Frontend compiles
cd frontend && npm run build
```

---

## Success Criteria

- [ ] Can create API key from dashboard
- [ ] Key shown only once on creation
- [ ] Can copy key to clipboard
- [ ] Can delete/revoke API key
- [ ] API endpoints require valid key
- [ ] Invalid key returns 401
- [ ] Expired key returns 401
- [ ] last_used_at updates on each use
- [ ] GitHub Action docs updated
- [ ] All files under 300 lines

---

## Dependencies

- **Requires**: Prompt 1 (Database), Prompt 2 (Auth)
- **Blocks**: Prompt 8 (Deployment needs API auth)

---

## Security Considerations

- Never store raw API keys, only hashes
- Use constant-time comparison for key verification
- Log API key usage (but not the key itself)
- Rate limit API key creation (max 10 per user)
- Keys should be revocable immediately
