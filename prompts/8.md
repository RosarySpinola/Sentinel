# Prompt 8: Production Deployment

**Priority**: High
**Skill**: none (DevOps)

---

## Pre-Task: Read Relevant Issues

Before starting, check for documented issues:
```bash
cat docs/issues/tooling/README.md
```

---

## Objective

Deploy Sentinel to production with:
- Frontend on Vercel
- API on Railway (or Fly.io)
- PostgreSQL on Railway (or Supabase)
- Redis on Upstash
- GitHub Actions for CI/CD

---

## Current State

- Frontend ready for deployment
- API ready for deployment
- No deployment configuration
- No CI/CD pipeline

---

## Requirements

### 1. Create Frontend Deployment Config

Create `frontend/vercel.json`:
```json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "env": {
    "NEXT_PUBLIC_API_URL": "@sentinel-api-url"
  }
}
```

### 2. Create API Dockerfile

Create `api/Dockerfile`:
```dockerfile
FROM rust:1.75-slim as builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/target/release/sentinel-api /usr/local/bin/
EXPOSE 3001
CMD ["sentinel-api"]
```

### 3. Create Railway Config

Create `api/railway.toml`:
```toml
[build]
builder = "dockerfile"
dockerfilePath = "Dockerfile"

[deploy]
startCommand = "sentinel-api"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
```

### 4. Create GitHub Actions Workflow

Create `.github/workflows/deploy.yml`:
```yaml
name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - run: cd frontend && npm ci
      - run: cd frontend && npm run lint
      - run: cd frontend && npm run build

  test-api:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: sentinel_test
        ports:
          - 5432:5432
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cd api && cargo test
        env:
          DATABASE_URL: postgres://postgres:test@localhost:5432/sentinel_test
          REDIS_URL: redis://localhost:6379

  deploy-frontend:
    needs: [test-frontend]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend

  deploy-api:
    needs: [test-api]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: railwayapp/railway-github-action@v1
        with:
          service: sentinel-api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

### 5. Create E2E Test Workflow

Create `.github/workflows/e2e.yml`:
```yaml
name: E2E Tests

on:
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: cd frontend && npm ci
      - run: npx playwright install --with-deps
      - run: cd frontend && npm run build
      - run: cd frontend && npm run test:e2e
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
```

### 6. Create Production Environment Template

Create `frontend/.env.production.example`:
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxx
CLERK_SECRET_KEY=sk_live_xxx
CLERK_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_API_URL=https://api.sentinel.dev
```

Create `api/.env.production.example`:
```
DATABASE_URL=postgres://user:pass@host:5432/sentinel
REDIS_URL=redis://default:xxx@region.upstash.io:6379
RUST_LOG=info
PORT=3001
CORS_ORIGINS=https://sentinel.dev,https://www.sentinel.dev
```

### 7. Create Health Check Improvements

Modify `api/src/routes/health.rs`:
- Check database connection
- Check Redis connection
- Return status of each dependency
- Return version info

```rust
{
  "status": "healthy",
  "version": "1.0.0",
  "dependencies": {
    "database": "connected",
    "redis": "connected"
  },
  "uptime_seconds": 12345
}
```

### 8. Create Sentry Integration

Add error monitoring:

**Frontend** (`frontend/lib/sentry.ts`):
- Initialize Sentry with DSN
- Capture unhandled errors
- Add user context

**API** (`api/src/error.rs`):
- Add sentry-rust crate
- Capture API errors
- Add request context

### 9. Create Database Migration Script

Create `scripts/migrate.sh`:
```bash
#!/bin/bash
set -e

echo "Running database migrations..."
cd api
sqlx migrate run

echo "Migrations complete!"
```

### 10. Create Deployment Checklist

Create `docs/DEPLOYMENT.md`:
- Prerequisites (accounts needed)
- Environment variable setup
- Database setup steps
- Redis setup steps
- Domain configuration
- SSL certificates
- Monitoring setup
- Rollback procedures

---

## Files to Create/Modify

- `frontend/vercel.json` - CREATE
- `api/Dockerfile` - CREATE
- `api/railway.toml` - CREATE
- `.github/workflows/deploy.yml` - CREATE
- `.github/workflows/e2e.yml` - CREATE
- `frontend/.env.production.example` - CREATE
- `api/.env.production.example` - CREATE
- `api/src/routes/health.rs` - MODIFY
- `frontend/lib/sentry.ts` - CREATE
- `api/Cargo.toml` - MODIFY (add sentry)
- `api/src/error.rs` - MODIFY
- `scripts/migrate.sh` - CREATE
- `docs/DEPLOYMENT.md` - CREATE

---

## Required Accounts/Services

| Service | Purpose | Free Tier |
|---------|---------|-----------|
| Vercel | Frontend hosting | Yes |
| Railway | API hosting | $5 credit |
| Upstash | Redis | 10K commands/day |
| Clerk | Auth | 10K MAU |
| Sentry | Error monitoring | 5K errors/month |
| GitHub | CI/CD | Unlimited |

---

## Environment Variables Reference

### Vercel (Frontend)

| Variable | Description |
|----------|-------------|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk public key |
| `CLERK_SECRET_KEY` | Clerk secret key |
| `CLERK_WEBHOOK_SECRET` | Clerk webhook signing |
| `NEXT_PUBLIC_API_URL` | Backend API URL |
| `SENTRY_DSN` | Sentry project DSN |

### Railway (API)

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string |
| `REDIS_URL` | Redis connection string |
| `RUST_LOG` | Log level (info/debug) |
| `PORT` | Server port (3001) |
| `CORS_ORIGINS` | Allowed origins |
| `SENTRY_DSN` | Sentry project DSN |

---

## Verification

```bash
# 1. Test Docker build locally
cd api && docker build -t sentinel-api .
docker run -p 3001:3001 sentinel-api

# 2. Test GitHub Actions locally (optional)
act -j test-frontend
act -j test-api

# 3. Check deployment
curl https://api.sentinel.dev/health
# Should return healthy status

# 4. Check frontend
curl https://sentinel.dev
# Should return HTML
```

---

## Success Criteria

- [ ] Frontend deploys to Vercel automatically
- [ ] API deploys to Railway automatically
- [ ] Database migrations run on deploy
- [ ] Health check returns all green
- [ ] E2E tests run on PRs
- [ ] Sentry captures errors
- [ ] CORS configured correctly
- [ ] SSL works on both domains
- [ ] Deployment docs complete

---

## Dependencies

- **Requires**: All previous prompts (1-7)
- **Blocks**: None (final prompt)

---

## Post-Deployment

After successful deployment:

1. Verify production flows:
   - User signup/login
   - Create project
   - Run simulation
   - View history
   - Generate API key

2. Set up monitoring alerts:
   - Error rate > 1%
   - Response time > 2s
   - Database connections > 80%

3. Configure backups:
   - Database: Daily automated
   - Redis: Not needed (cache)
